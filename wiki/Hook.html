<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en" xmlns="http://www.w3.org/1999/html"><!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <title>Hook |  OrientDB</title>
  <title>Hook</title>
  <link href="../stylesheets/foundation.min.css" media="screen" rel="stylesheet" type="text/css" />
<link href="../stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="../javascripts/modernizr.foundation.js" type="text/javascript"></script>
  
</head>
<body class="orientdb orientdb_wiki orientdb_wiki_Hook">

<header>
  <div class="row">
    <div class="five columns">
      <h1>
        <a href="/">
          Orient<span class="highl">DB</span>
        </a>
        <span class="subtitle">The Document/Graph NoSQL Database</span>
      </h1>
    </div>
    <div class="seven columns right">
      <ul class="inline-list">
        <li><a href="/orientdb/"> Home</a></li>
<li><a href="/orientdb/about.html"> About</a></li>
<li class="active"><a href="/orientdb/wiki/Home.html"> Documentation</a></li>
<li><a href="/orientdb/wiki/Download.html"> Downloads</a></li>
<li><a href="/orientdb/community.html"> Community</a></li>
      </ul>
    </div>
  </div>
</header>


<div class="page-header">
  <div class="row">
    <div class="twelve columns">
      <h2>
        <i class="icon-orientdb"></i>
        Hook
        
          <ul class="bcs">
          
            <li><a href="/orientdb/wiki/Java-API.html" class="nr1">Java Api</a></li>
          
            <li><a href="/orientdb/wiki/Home.html" class="nr2">Home</a></li>
          
          </ul>
        
        
      </h2>
    </div>
  </div>
</div>

<div id="main" class="row wiki">

  <div class="twelve columns content" role="content">

    <h3>Introduction</h3>

<p>Hook works like a trigger. Hook lets to the user application to intercept internal events before and after each CRUD operation against records. You can use to write custom validation rules, to enforce security or even to orchestrate external events like the replication against a Relational DBMS.</p>

<h3>The ORecordHook interface</h3>

<p>A hook is an implementation of the interface <a href="http://code.google.com/p/orient/source/browse/trunk/core/src/main/java/com/orientechnologies/orient/core/hook/ORecordHook.java">ORecordHook</a>:</p>

<div class="highlight"><pre>  <span class="kd">public</span> <span class="kd">interface</span> <span class="nc">ORecordHook</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">enum</span> <span class="n">TYPE</span> <span class="o">{</span>
      <span class="n">ANY</span><span class="o">,</span>
      <span class="n">BEFORE_CREATE</span><span class="o">,</span> <span class="n">BEFORE_READ</span><span class="o">,</span> <span class="n">BEFORE_UPDATE</span><span class="o">,</span> <span class="n">BEFORE_DELETE</span><span class="o">,</span>
      <span class="n">AFTER_CREATE</span><span class="o">,</span> <span class="n">AFTER_READ</span><span class="o">,</span> <span class="n">AFTER_UPDATE</span><span class="o">,</span> <span class="n">AFTER_DELETE</span>
    <span class="o">};</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onTrigger</span><span class="o">(</span><span class="n">TYPE</span> <span class="n">iType</span><span class="o">,</span> <span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">);</span>
  <span class="o">}</span>
</pre></div>

<h3>The ORecordHookAbstract abstract class</h3>

<p>OrientDB comes with an abstract implementation of the <a href="http://code.google.com/p/orient/source/browse/trunk/core/src/main/java/com/orientechnologies/orient/core/hook/ORecordHook.java">ORecordHook</a> interface called <a href="http://code.google.com/p/orient/source/browse/trunk/core/src/main/java/com/orientechnologies/orient/core/hook/ORecordHookAbstract.java">ORecordHookAbstract.java</a>. It switches the callback event calling seperate methods for each one:</p>

<div class="highlight"><pre>  <span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">ORecordHookAbstract</span> <span class="kd">implements</span> <span class="n">ORecordHook</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordBeforeCreate</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordAfterCreate</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordBeforeRead</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordAfterRead</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordBeforeUpdate</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordAfterUpdate</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordBeforeDelete</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordAfterDelete</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){}</span>
    <span class="o">...</span>
</pre></div>

<h3>Hook example</h3>

<p>In this example the events "*before-create*" and "*after-delete*" are called during the save() of the Profile object where:</p>

<ul>
<li>
<em>before-create</em> is used to check custom validation rules</li>
<li>
<em>after-delete</em> is used to maintain the references valid</li>
</ul><div class="highlight"><pre>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">HookTest</span> <span class="kd">extends</span> <span class="n">ORecordHookAbstract</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="nf">saveProfile</span><span class="o">(){</span>
      <span class="n">ODatabaseObjectTx</span> <span class="n">database</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ODatabaseObjectTx</span><span class="o">(</span><span class="s">"remote:localhost/demo"</span><span class="o">);</span>
      <span class="n">database</span><span class="o">.</span><span class="na">open</span><span class="o">(</span><span class="s">"writer"</span><span class="o">,</span> <span class="s">"writer"</span><span class="o">);</span>
  
      <span class="c1">// REGISTER MYSELF AS HOOK</span>
      <span class="n">database</span><span class="o">.</span><span class="na">registerHook</span><span class="o">(</span><span class="k">this</span><span class="o">);</span>
  
      <span class="o">...</span>
      <span class="n">p</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Profile</span><span class="o">(</span><span class="s">"Luca"</span><span class="o">);</span>
      <span class="n">p</span><span class="o">.</span><span class="na">setAge</span><span class="o">(</span><span class="mi">10000</span><span class="o">);</span>
      <span class="n">database</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">p</span><span class="o">);</span>
      <span class="o">...</span>
    <span class="o">}</span>
  
    <span class="cm">/**</span>
<span class="cm">     * Custom validation rules</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordBeforeCreate</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){</span>
      <span class="k">if</span><span class="o">(</span> <span class="n">iRecord</span> <span class="k">instanceof</span> <span class="n">ODocument</span> <span class="o">){</span>
        <span class="n">ODocument</span> <span class="n">doc</span> <span class="o">=</span> <span class="o">(</span><span class="n">ODocument</span><span class="o">)</span> <span class="n">iRecord</span><span class="o">;</span>
        <span class="n">Integer</span> <span class="n">age</span> <span class="o">=</span> <span class="n">doc</span> <span class="o">.</span><span class="na">field</span><span class="o">(</span> <span class="s">"age"</span> <span class="o">);</span>
        <span class="k">if</span><span class="o">(</span> <span class="n">age</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">130</span> <span class="o">)</span>
          <span class="k">throw</span> <span class="k">new</span> <span class="nf">OValidationException</span><span class="o">(</span><span class="s">"Invalid age"</span><span class="o">);</span>
      <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="cm">/**</span>
<span class="cm">     * On deletion removes the reference back.</span>
<span class="cm">     */</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">onRecordAfterDelete</span><span class="o">(</span><span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">){</span>
      <span class="k">if</span><span class="o">(</span> <span class="n">iRecord</span> <span class="k">instanceof</span> <span class="n">ODocument</span> <span class="o">){</span>
        <span class="n">ODocument</span> <span class="n">doc</span> <span class="o">=</span> <span class="o">(</span><span class="n">ODocument</span><span class="o">)</span> <span class="n">iRecord</span><span class="o">;</span>
  
        <span class="n">Set</span><span class="o">&lt;</span><span class="n">OIdentifiable</span><span class="o">&gt;</span> <span class="n">friends</span> <span class="o">=</span> <span class="n">doc</span><span class="o">.</span><span class="na">field</span><span class="o">(</span> <span class="s">"friends"</span> <span class="o">);</span>
        <span class="k">if</span><span class="o">(</span> <span class="n">friends</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">){</span>
          <span class="k">for</span><span class="o">(</span> <span class="n">OIdentifiable</span> <span class="n">friend</span> <span class="o">:</span> <span class="n">friends</span> <span class="o">){</span>
            <span class="n">Set</span><span class="o">&lt;</span><span class="n">OIdentifiable</span><span class="o">&gt;</span> <span class="n">otherFriends</span> <span class="o">=</span> <span class="o">((</span><span class="n">ODocument</span><span class="o">)</span><span class="n">friend</span><span class="o">.</span><span class="na">getRecord</span><span class="o">()).</span><span class="na">field</span><span class="o">(</span><span class="s">"friends"</span><span class="o">);</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">friends</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">)</span>
              <span class="n">friends</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span> <span class="n">iRecord</span> <span class="o">);</span>
          <span class="o">}</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>  
</pre></div>

<p>For more information take a look to the <a href="http://code.google.com/p/orient/source/browse/trunk/tests/src/test/java/com/orientechnologies/orient/test/database/auto/HookTest.java">HookTest.java</a> source code.</p>

<h3>Install server-side hooks</h3>

<p>To let a hook to be executed in the Server space you've to register it in the server <code>orientdb-server-config.xml</code> configuration file. </p>

<h4>Write your hook</h4>

<p>Example of a hook to execute custom validation rules:
</p><div class="highlight"><pre>  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">CustomValidationRules</span> <span class="kd">implements</span> <span class="n">ORecordHook</span><span class="o">{</span>
    <span class="cm">/**</span>
<span class="cm">     * Apply custom validation rules</span>
<span class="cm">     */</span>
    <span class="kd">public</span> <span class="kt">boolean</span> <span class="nf">onTrigger</span><span class="o">(</span><span class="kd">final</span> <span class="n">TYPE</span> <span class="n">iType</span><span class="o">,</span> <span class="kd">final</span> <span class="n">ORecord</span><span class="o">&lt;?&gt;</span> <span class="n">iRecord</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">if</span><span class="o">(</span> <span class="n">iRecord</span> <span class="k">instanceof</span> <span class="n">ODocument</span> <span class="o">){</span>
        <span class="n">ODocument</span> <span class="n">doc</span> <span class="o">=</span> <span class="o">(</span><span class="n">ODocument</span><span class="o">)</span> <span class="n">iRecord</span><span class="o">;</span>
  
        <span class="k">switch</span><span class="o">(</span> <span class="n">iType</span> <span class="o">){</span>
          <span class="k">case</span> <span class="nl">BEFORE_CREATE:</span>
          <span class="k">case</span> <span class="nl">BEFORE_UPDATE:</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">doc</span><span class="o">.</span><span class="na">getClassName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"Customer"</span><span class="o">)</span> <span class="o">){</span>
              <span class="n">Integer</span> <span class="n">age</span> <span class="o">=</span> <span class="n">doc</span> <span class="o">.</span><span class="na">field</span><span class="o">(</span> <span class="s">"age"</span> <span class="o">);</span>
              <span class="k">if</span><span class="o">(</span> <span class="n">age</span> <span class="o">!=</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">age</span> <span class="o">&gt;</span> <span class="mi">130</span> <span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">OValidationException</span><span class="o">(</span><span class="s">"Invalid age"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
  
          <span class="k">case</span> <span class="nl">BEFORE_DELETE:</span> <span class="o">{</span>
            <span class="k">if</span><span class="o">(</span> <span class="n">doc</span><span class="o">.</span><span class="na">getClassName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span><span class="s">"Customer"</span><span class="o">)</span> <span class="o">){</span>
              <span class="kd">final</span> <span class="n">ODatabaseRecord</span> <span class="n">db</span> <span class="o">=</span> <span class="n">ODatabaseRecordThreadLocal</span><span class="o">.</span><span class="na">INSTANCE</span><span class="o">.</span><span class="na">get</span><span class="o">();</span>
              <span class="k">if</span><span class="o">(</span> <span class="o">!</span><span class="n">db</span><span class="o">.</span><span class="na">getUser</span><span class="o">().</span><span class="na">getName</span><span class="o">().</span><span class="na">equals</span><span class="o">(</span> <span class="s">"admin"</span> <span class="o">)</span> <span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="nf">OSecurityException</span><span class="o">(</span><span class="s">"Only admin can delete customers"</span><span class="o">);</span>
            <span class="o">}</span>
            <span class="k">break</span><span class="o">;</span>
          <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>

<h4>Deploy the hook</h4>

<p>Once implemented create a .jar file containing your class and put it under the $ORIENTDB_HOME/lib directory.</p>

<h5>Register it in the server configuration</h5>

<p>Change the <code>orientdb-server-config.xml</code> file adding your hook inside the <code>&lt;hooks&gt;</code> tag. The position can be one of following values FIRST, EARLY, REGULAR, LATE, LAST:
</p><div class="highlight"><pre>  <span class="nt">&lt;hook</span> <span class="na">class=</span><span class="s">"org.orientdb.test.MyHook"</span> <span class="na">position=</span><span class="s">"REGULAR"</span><span class="nt">/&gt;</span>
</pre></div>

<h4>Configurable hooks</h4>

<p>If your hook must be configurable with external parameters write the parameters in the orientdb-server-config.xml file:
</p><div class="highlight"><pre>  <span class="nt">&lt;hook</span> <span class="na">class=</span><span class="s">"org.orientdb.test.MyHook"</span> <span class="na">position=</span><span class="s">"REGULAR"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;parameters&gt;</span>
      <span class="nt">&lt;parameter</span> <span class="na">name=</span><span class="s">"userCanDelete"</span> <span class="na">value=</span><span class="s">"admin"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/parameters&gt;</span>
  <span class="nt">&lt;/hook&gt;</span>
</pre></div>

<p>And in your Java class implement the config() method to read the parameter:
</p><div class="highlight"><pre><span class="kd">private</span> <span class="n">String</span> <span class="n">userCanDelete</span><span class="o">;</span>
<span class="o">...</span>
<span class="kd">public</span> <span class="kt">void</span> <span class="nf">config</span><span class="o">(</span><span class="n">OServer</span> <span class="n">oServer</span><span class="o">,</span> <span class="n">OServerParameterConfiguration</span><span class="o">[]</span> <span class="n">iParams</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">for</span> <span class="o">(</span><span class="n">OServerParameterConfiguration</span> <span class="n">param</span> <span class="o">:</span> <span class="n">iParams</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">param</span><span class="o">.</span><span class="na">name</span><span class="o">.</span><span class="na">equalsIgnoreCase</span><span class="o">(</span><span class="s">"userCanDelete"</span><span class="o">))</span> <span class="o">{</span>
      <span class="n">userCanDelete</span> <span class="o">=</span> <span class="n">param</span><span class="o">.</span><span class="na">value</span><span class="o">;</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="o">...</span>
</pre></div>


  </div>

</div>

<footer>
  <div class="row">
    <div class="six columns">
      <ul class="inline-list">
        <li><a href="/orientdb/"> Home</a></li>
<li><a href="/orientdb/about.html"> About</a></li>
<li class="active"><a href="/orientdb/wiki/Home.html"> Documentation</a></li>
<li><a href="/orientdb/wiki/Download.html"> Downloads</a></li>
<li><a href="/orientdb/community.html"> Community</a></li>
      </ul>
    </div>
    <div class="six columns">
      <p class="copyright">
        Copyright &copy; 2011-2012 NuvolaBase Ltd. <br/>
        <span class="small">NuvolaBase is a registered trademark. All Rights Reserved.</span>
      </p>
    </div>
  </div>
</footer>

<script src="../javascripts/app.js" type="text/javascript"></script>

</body>
</html>