<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!-->
<html class="no-js" lang="en" xmlns="http://www.w3.org/1999/html"><!--<![endif]-->
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <meta content="IE=edge,chrome=1" http-equiv="X-UA-Compatible">
  <title>Java Web Apps |  OrientDB</title>
  <title>Java Web Apps</title>
  <link href="../stylesheets/foundation.min.css" media="screen" rel="stylesheet" type="text/css" />
<link href="../stylesheets/app.css" media="screen" rel="stylesheet" type="text/css" />
  <script src="../javascripts/modernizr.foundation.js" type="text/javascript"></script>
  
</head>
<body class="orientdb orientdb_wiki orientdb_wiki_Java-Web-Apps">

<header>
  <div class="row">
    <div class="five columns">
      <h1>
        <a href="/orientdb/">
          Orient<span class="highl">DB</span>
        </a>
        <span class="subtitle">The Document/Graph NoSQL Database</span>
      </h1>
    </div>
    <div class="seven columns right">
      <ul class="inline-list">
        <li><a href="/orientdb/"> Home</a></li>
<li><a href="/orientdb/about.html"> About</a></li>
<li class="active"><a href="/orientdb/wiki/Home.html"> Documentation</a></li>
<li><a href="/orientdb/wiki/Download.html"> Downloads</a></li>
<li><a href="/orientdb/community.html"> Community</a></li>
      </ul>
    </div>
  </div>
</header>


<div class="page-header">
  <div class="row">
    <div class="twelve columns">
      <h2>
        <i class="icon-orientdb"></i>
        Java Web Apps
        
          <ul class="bcs">
          
            <li><a href="/orientdb/wiki/Java-API.html" class="nr1">Java Api</a></li>
          
            <li><a href="/orientdb/wiki/Home.html" class="nr2">Home</a></li>
          
          </ul>
        
        
      </h2>
    </div>
  </div>
</div>

<div id="main" class="row wiki">

  <div class="twelve columns content" role="content">

    <h3>Introduction</h3>

<p>The database instances are not thread-safe, so each thread needs a own instance. All the database instances will share the same connection to the storage for the same URL. For more information look at <a class="internal present" href="/orientdb/wiki/Java-Multi-Threading.html">Java Multi threads and databases</a>.</p>

<p>Java WebApp runs inside a Servlet container with a pool of threads that work the requests.</p>

<p>There are mainly 2 solutions:</p>

<ul>
<li>Manual control of the database instances from <strong>Servlets</strong> (or any other server-side technology like Apache Struts Actions, Spring MVC, etc.)</li>
<li>Automatic control using <strong>Servlet Filters</strong>
</li>
</ul><h3>Manual control</h3>

<div class="highlight"><pre>  <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">orientechnologies</span><span class="o">.</span><span class="na">test</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">javax.servlet.*</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">Example</span> <span class="kd">extends</span> <span class="n">HttpServlet</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doGet</span><span class="o">(</span><span class="n">HttpServletRequest</span> <span class="n">request</span><span class="o">,</span>
                      <span class="n">HttpServletResponse</span> <span class="n">response</span><span class="o">)</span>
          <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span>
    <span class="o">{</span>
      <span class="n">ODatabaseDocument</span> <span class="n">database</span> <span class="o">=</span> <span class="n">ODatabaseDocumentPool</span><span class="o">.</span><span class="na">global</span><span class="o">().</span><span class="na">acquire</span><span class="o">(</span><span class="s">"local:/temp/db"</span><span class="o">,</span> <span class="s">"admin"</span><span class="o">,</span> <span class="s">"admin"</span><span class="o">);</span>
  
      <span class="k">try</span> <span class="o">{</span>
  
       <span class="c1">// USER CODE</span>
  
      <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
        <span class="n">database</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
      <span class="o">}</span>    
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>

<h3>Automatic control using Servlet Filters</h3>

<p>Servlets are the best way to automatise database control inside WebApps. The trick is to create a Filter that get a database from the pool and binds it in current ThreadLocal before to execute the Servlet code. Once returned the ThreadLocal is cleared and database released to the pool.</p>

<p><a href="http://www.oracle.com/technetwork/java/javaee/servlet/index.html">JaveEE Servlets</a></p>

<h4>Create a Filter class</h4>

<h5>Create a database instance per request</h5>

<p>In this example a new database instance is created per request, opened and at the end closed.
</p><div class="highlight"><pre>  <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">orientechnologies</span><span class="o">.</span><span class="na">test</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">javax.servlet.*</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrientDBFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span>
            <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ODatabaseDocument</span> <span class="n">database</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ODatabaseDocumentTx</span><span class="o">(</span><span class="s">"local:/temp/db"</span><span class="o">).</span><span class="na">open</span><span class="o">(</span><span class="s">"admin"</span><span class="o">,</span> <span class="s">"admin"</span><span class="o">);</span>
        <span class="k">try</span><span class="o">{</span>
          <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="n">database</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>

<h5>Use the database pool</h5>

<p>In this example the database pool is used.
</p><div class="highlight"><pre>  <span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">orientechnologies</span><span class="o">.</span><span class="na">test</span><span class="o">;</span>
  <span class="kn">import</span> <span class="nn">javax.servlet.*</span><span class="o">;</span>
  
  <span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrientDBFilter</span> <span class="kd">implements</span> <span class="n">Filter</span> <span class="o">{</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">doFilter</span><span class="o">(</span><span class="n">ServletRequest</span> <span class="n">request</span><span class="o">,</span> <span class="n">ServletResponse</span> <span class="n">response</span><span class="o">,</span>
            <span class="n">FilterChain</span> <span class="n">chain</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">ODatabaseDocument</span> <span class="n">database</span> <span class="o">=</span> <span class="n">ODatabaseDocumentPool</span><span class="o">.</span><span class="na">global</span><span class="o">().</span><span class="na">acquire</span><span class="o">(</span><span class="s">"local:/temp/db"</span><span class="o">,</span> <span class="s">"admin"</span><span class="o">,</span> <span class="s">"admin"</span><span class="o">);</span>
        <span class="k">try</span><span class="o">{</span>
          <span class="n">chain</span><span class="o">.</span><span class="na">doFilter</span><span class="o">(</span><span class="n">request</span><span class="o">,</span> <span class="n">response</span><span class="o">);</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
          <span class="n">database</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
  
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">destroy</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">ODatabaseDocumentPool</span><span class="o">.</span><span class="na">global</span><span class="o">().</span><span class="na">close</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>
</pre></div>

<h4>Register the filter</h4>

<p>Now we've create the filter class it needs to be registered in the <strong>web.xml</strong> file:
</p><div class="highlight"><pre>  <span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
  <span class="nt">&lt;web-app</span> <span class="na">xmlns=</span><span class="s">"http://java.sun.com/xml/ns/j2ee"</span>
           <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
           <span class="na">xsi:schemaLocation=</span><span class="s">"http://java.sun.com/xml/ns/j2ee </span>
<span class="s">           http://java.sun.com/xml/ns/j2ee/web-app_2_4.xsd"</span>
           <span class="na">version=</span><span class="s">"2.4"</span><span class="nt">&gt;</span>  
    <span class="nt">&lt;filter&gt;</span>     
      <span class="nt">&lt;filter-name&gt;</span>OrientDB<span class="nt">&lt;/filter-name&gt;</span>   
      <span class="nt">&lt;filter-class&gt;</span>com.orientechnologies.test.OrientDBFilter<span class="nt">&lt;/filter-class&gt;</span>  
    <span class="nt">&lt;/filter&gt;</span> 
      <span class="nt">&lt;filter-mapping&gt;</span>   
        <span class="nt">&lt;filter-name&gt;</span>OrientDB<span class="nt">&lt;/filter-name&gt;</span>   
        <span class="nt">&lt;url-pattern&gt;</span>/*<span class="nt">&lt;/url-pattern&gt;</span>   
      <span class="nt">&lt;/filter-mapping&gt;</span> 
      <span class="nt">&lt;session-config&gt;</span>   
        <span class="nt">&lt;session-timeout&gt;</span>30<span class="nt">&lt;/session-timeout&gt;</span>   
      <span class="nt">&lt;/session-config&gt;</span> 
  <span class="nt">&lt;/web-app&gt;</span>
</pre></div>


  </div>

</div>

<footer>
  <div class="row">
    <div class="six columns">
      <ul class="inline-list">
        <li><a href="/orientdb/"> Home</a></li>
<li><a href="/orientdb/about.html"> About</a></li>
<li class="active"><a href="/orientdb/wiki/Home.html"> Documentation</a></li>
<li><a href="/orientdb/wiki/Download.html"> Downloads</a></li>
<li><a href="/orientdb/community.html"> Community</a></li>
      </ul>
    </div>
    <div class="six columns">
      <p class="copyright">
        Copyright &copy; 2011-2012 NuvolaBase Ltd. <br/>
        <span class="small">NuvolaBase is a registered trademark. All Rights Reserved.</span>
      </p>
    </div>
  </div>
</footer>

<script src="../javascripts/app.js" type="text/javascript"></script>

</body>
</html>